

.. _sphx_glr_auto_examples_plot_sensor_spatio_temporal_cluster_stats.py:


============================================================
Non-parametric spatio-temporal statistics on EEG sensor data
============================================================

Run a non-parametric spatio-temporal cluster stats on EEG sensors
on the contrast faces vs. scrambled.



.. code-block:: python


    import os.path as op
    import numpy as np
    from scipy import stats
    from scipy import spatial
    import matplotlib.pyplot as plt
    from mpl_toolkits.axes_grid1 import make_axes_locatable

    import mne
    from mne.stats import permutation_cluster_1samp_test
    from mne.viz import plot_topomap

    from library.config import meg_dir, l_freq







Read all the data



.. code-block:: python


    exclude = [1, 5, 16]  # Excluded subjects

    contrasts = list()

    for subject_id in range(1, 20):
        if subject_id in exclude:
            continue
        subject = "sub%03d" % subject_id
        print("processing subject: %s" % subject)
        data_path = op.join(meg_dir, subject)
        contrast = mne.read_evokeds(op.join(data_path, '%s_highpass-%sHz_ave.fif'
                                            % (subject, l_freq)),
                                    condition='contrast')
        contrast.pick_types(meg=False, eeg=True)
        contrast.apply_baseline((-0.2, 0.0))
        contrasts.append(contrast)

    contrast = mne.combine_evoked(contrasts, 'equal')





.. rst-class:: sphx-glr-script-out

 Out::

    processing subject: sub002
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub002/sub002_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub002/sub002_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 171 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub003
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub003/sub003_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub003/sub003_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 149 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub004
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub004/sub004_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub004/sub004_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 159 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub006
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub006/sub006_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub006/sub006_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 150 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub007
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub007/sub007_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub007/sub007_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 194 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub008
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub008/sub008_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub008/sub008_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 195 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub009
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub009/sub009_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub009/sub009_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 177 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub010
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub010/sub010_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub010/sub010_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 188 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub011
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub011/sub011_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub011/sub011_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 186 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub012
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub012/sub012_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub012/sub012_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 186 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub013
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub013/sub013_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub013/sub013_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 162 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub014
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub014/sub014_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub014/sub014_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 185 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub015
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub015/sub015_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub015/sub015_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 140 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub017
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub017/sub017_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub017/sub017_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 157 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub018
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub018/sub018_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub018/sub018_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 188 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)
    processing subject: sub019
    This filename (/tsi/doctorants/data_gramfort/dgw_faces/MEG/sub019/sub019_highpass-1Hz_ave.fif) does not conform to MNE naming conventions. All evoked files should end with -ave.fif or -ave.fif.gz
    Reading /tsi/doctorants/data_gramfort/dgw_faces/MEG/sub019/sub019_highpass-1Hz_ave.fif ...
        Read a total of 1 projection items:
            Average EEG reference (1 x 70) active
        Found the data of interest:
            t =    -200.00 ...     800.00 ms (contrast)
            0 CTF compensation matrices available
            nave = 183 - aspect type = 100
    Projections have already been applied. Setting proj attribute to True.
    No baseline correction applied
    Applying baseline correction (mode: mean)


Assemble the data and run the cluster stats on channel data



.. code-block:: python


    data = np.array([c.data for c in contrasts])

    n_permutations = 1  # number of permutations to run

    # set family-wise p-value
    p_accept = 0.01

    connectivity = None
    tail = 0.  # for two sided test

    # set cluster threshold
    ppf = stats.t.ppf
    p_thresh = p_accept / (1 + (tail == 0))
    n_samples = len(data)
    threshold = -ppf(p_thresh, n_samples - 1)
    if np.sign(tail) < 0:
        threshold = -threshold

    # Make a triangulation between EEG channels locations to
    # use as connectivity for cluster level stat
    # XXX : make a mne.channels.make_eeg_connectivity function
    lay = mne.channels.make_eeg_layout(contrast.info)
    neigh = spatial.Delaunay(lay.pos[:, :2]).vertices
    connectivity = mne.surface.mesh_edges(neigh)

    data = np.transpose(data, (0, 2, 1))  # transpose for clustering

    cluster_stats = permutation_cluster_1samp_test(
        data, threshold=threshold, n_jobs=2, verbose=True, tail=1,
        connectivity=connectivity, out_type='indices',
        check_disjoint=True)

    T_obs, clusters, p_values, _ = cluster_stats
    good_cluster_inds = np.where(p_values < p_accept)[0]

    print("Good clusters: %s" % good_cluster_inds)





.. rst-class:: sphx-glr-script-out

 Out::

    stat_fun(H1): min=-11.518583 max=9.737209
    No disjoint connectivity sets found
    Running initial clustering
    Found 9 clusters
    Permuting ...
    Computing cluster p-values
    Done.
    Good clusters: [4 6]


Visualize the spatio-temporal clusters



.. code-block:: python


    times = contrast.times * 1e3
    colors = 'r', 'steelblue'
    linestyles = '-', '--'

    pos = mne.find_layout(contrast.info).pos

    T_obs_max = 5.
    T_obs_min = -T_obs_max

    # loop over significant clusters
    for i_clu, clu_idx in enumerate(good_cluster_inds):
        # unpack cluster information, get unique indices
        time_inds, space_inds = np.squeeze(clusters[clu_idx])
        ch_inds = np.unique(space_inds)
        time_inds = np.unique(time_inds)

        # get topography for T0 stat
        T_obs_map = T_obs[time_inds, ...].mean(axis=0)

        # get signals at significant sensors
        signals = data[..., ch_inds].mean(axis=-1)
        sig_times = times[time_inds]

        # create spatial mask
        mask = np.zeros((T_obs_map.shape[0], 1), dtype=bool)
        mask[ch_inds, :] = True

        # initialize figure
        fig, ax_topo = plt.subplots(1, 1, figsize=(10, 3))
        title = 'Cluster #{0}'.format(i_clu + 1)
        fig.suptitle(title, fontsize=14)

        # plot average test statistic and mark significant sensors
        image, _ = plot_topomap(T_obs_map, pos, mask=mask, axes=ax_topo,
                                vmin=T_obs_min, vmax=T_obs_max,
                                show=False)

        # advanced matplotlib for showing image with figure and colorbar
        # in one plot
        divider = make_axes_locatable(ax_topo)

        # add axes for colorbar
        ax_colorbar = divider.append_axes('right', size='5%', pad=0.05)
        plt.colorbar(image, cax=ax_colorbar)
        ax_topo.set_xlabel('Averaged T-map ({:0.1f} - {:0.1f} ms)'.format(
            *sig_times[[0, -1]]
        ))

        # add new axis for time courses and plot time courses
        ax_signals = divider.append_axes('right', size='300%', pad=1.2)
        for signal, name, col, ls in zip(signals, ['Contrast'], colors,
                                         linestyles):
            ax_signals.plot(times, signal, color=col, linestyle=ls, label=name)

        # add information
        ax_signals.axvline(0, color='k', linestyle=':', label='stimulus onset')
        ax_signals.set_xlim([times[0], times[-1]])
        ax_signals.set_xlabel('time [ms]')
        ax_signals.set_ylabel('evoked [uV]')

        # plot significant time range
        ymin, ymax = ax_signals.get_ylim()
        ax_signals.fill_betweenx((ymin, ymax), sig_times[0], sig_times[-1],
                                 color='orange', alpha=0.3)
        ax_signals.legend(loc='lower right')
        ax_signals.set_ylim(ymin, ymax)

        # clean up viz
        mne.viz.tight_layout(fig=fig)
        fig.subplots_adjust(bottom=.05)
        plt.show()
        plt.savefig('spatiotemporal_stats_cluster-%02d.pdf' % i_clu)



.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /auto_examples/images/sphx_glr_plot_sensor_spatio_temporal_cluster_stats_001.png
            :scale: 47

    *

      .. image:: /auto_examples/images/sphx_glr_plot_sensor_spatio_temporal_cluster_stats_002.png
            :scale: 47




**Total running time of the script:** ( 0 minutes  43.322 seconds)



.. container:: sphx-glr-footer


  .. container:: sphx-glr-download

     :download:`Download Python source code: plot_sensor_spatio_temporal_cluster_stats.py <plot_sensor_spatio_temporal_cluster_stats.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: plot_sensor_spatio_temporal_cluster_stats.ipynb <plot_sensor_spatio_temporal_cluster_stats.ipynb>`

.. rst-class:: sphx-glr-signature

    `Generated by Sphinx-Gallery <https://sphinx-gallery.readthedocs.io>`_
